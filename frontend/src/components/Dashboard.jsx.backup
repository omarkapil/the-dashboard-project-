import React, { useEffect, useState, useRef } from 'react';
import axios from 'axios';
import {
    Chart as ChartJS,
    CategoryScale,
    LinearScale,
    PointElement,
    LineElement,
    BarElement,
    ArcElement,
    RadialLinearScale,
    Title,
    Tooltip,
    Legend,
    Filler,
} from 'chart.js';
import { Line, Bar, Radar, Doughnut } from 'react-chartjs-2';
import NetworkTopology from './NetworkTopology';
import { useAuth } from '../context/AuthContext';

ChartJS.register(
    CategoryScale,
    LinearScale,
    PointElement,
    LineElement,
    BarElement,
    ArcElement,
    RadialLinearScale,
    Title,
    Tooltip,
    Legend,
    Filler
);

import ErrorBoundary from './ErrorBoundary';
import TabNavigation from './TabNavigation';
import '../gradient-styles.css';

const Dashboard = () => {
    return (
        <ErrorBoundary>
            <DashboardContent />
        </ErrorBoundary>
    );
};

const DashboardContent = () => {
    const { token } = useAuth();
    const [data, setData] = useState(null);
    const [loading, setLoading] = useState(true);
    const [scanTarget, setScanTarget] = useState('127.0.0.1');
    const [error, setError] = useState(null);
    const [scanning, setScanning] = useState(false);
    const [activeTab, setActiveTab] = useState('overview');

    const tabs = [
        { id: 'overview', label: 'Overview', icon: 'ðŸ“Š' },
        { id: 'network', label: 'Network', icon: 'ðŸŒ' },
        { id: 'devices', label: 'Devices', icon: 'ðŸ’»' },
        { id: 'vulnerabilities', label: 'Vulnerabilities', icon: 'âš ï¸' },
        { id: 'reports', label: 'Reports', icon: 'ðŸ“„' }
    ];

    useEffect(() => {
        fetchData();
        fetchExternalRisk();
    }, []);

    const [externalRisk, setExternalRisk] = useState(null);

    const fetchExternalRisk = async () => {
        try {
            // For MVP, we check the scanTarget or a public IP. shodan needs a public IP.
            // Using a demo Google DNS or similar if scanTarget is local, 
            // but ideally this comes from configuration. 
            // We will use scanTarget for now.
            const response = await axios.get('http://localhost:5000/api/external-risk', {
                params: { ip: scanTarget },
                headers: { 'Authorization': `Bearer ${token}` }
            });
            setExternalRisk(response.data);
        } catch (error) {
            console.error("Error fetching external risk", error);
        }
    };

    // --- Threat Ticker Logic ---
    const [threats, setThreats] = useState([
        { id: 1, type: 'CRITICAL', message: 'Unauthorized access attempt on DB-01', time: '10:42:05' },
        { id: 2, type: 'WARNING', message: 'High latency detected on Web-Server', time: '10:41:12' },
        { id: 3, type: 'INFO', message: 'Scheduled scan completed successfully', time: '10:30:00' },
    ]);

    useEffect(() => {
        const interval = setInterval(() => {
            const newThreat = {
                id: Date.now(),
                type: Math.random() > 0.8 ? 'CRITICAL' : Math.random() > 0.5 ? 'WARNING' : 'INFO',
                message: `Simulated event: ${Math.random().toString(36).substring(7)}`,
                time: new Date().toLocaleTimeString()
            };
            setThreats(prev => [newThreat, ...prev].slice(0, 5));
        }, 5000);
        return () => clearInterval(interval);
    }, []);

    const fetchData = async () => {
        try {
            const response = await axios.get('http://localhost:5000/api/dashboard', {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            setData(response.data);
            setLoading(false);
        } catch (error) {
            console.error("Error fetching dashboard data", error);
            setError(error);
            setLoading(false);
        }
    };

    const handleScan = async () => {
        setScanning(true);
        try {
            await axios.post('http://localhost:5000/api/scan', { target: scanTarget }, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            alert(`Scan started for ${scanTarget}. Results will appear shortly.`);
        } catch (error) {
            console.error("Scan failed", error);
            alert("Failed to start scan");
        } finally {
            setScanning(false);
        }
    };

    const handleSchedule = async () => {
        try {
            await axios.post('http://localhost:5000/api/schedule', { target: scanTarget, interval_hours: 24 }, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            alert(`Schedule saved: Scan ${scanTarget} every 24 hours.`);
        } catch (error) {
            console.error("Schedule failed", error);
            alert("Failed to save schedule");
        }
    };

    if (loading) return <div className="min-h-screen bg-[#050505] flex items-center justify-center text-[#00f2ff] font-mono">Loading system...</div>;
    if (error) return (
        <div className="min-h-screen bg-[#050505] flex flex-col items-center justify-center text-red-500 font-mono p-4">
            <h2 className="text-xl mb-4">System Error: Data Unreachable</h2>
            <div className="bg-gray-900 p-4 rounded border border-red-900 max-w-2xl overflow-auto">
                <p className="font-bold text-white">Status: {error.response?.status}</p>
                <p className="mt-2 text-red-400">Message: {JSON.stringify(error.response?.data || error.message)}</p>
                <p className="mt-2 text-gray-500 text-sm">Token sent: {token?.substring(0, 10)}...</p>
            </div>
            <button onClick={() => window.location.reload()} className="mt-6 px-4 py-2 bg-red-900/30 border border-red-500 hover:bg-red-900/50 rounded transition-colors text-white">
                Retry Connection
            </button>
        </div>
    );
    if (!data) return <div className="min-h-screen bg-[#050505] flex items-center justify-center text-[#ffcc00] font-mono">Initializing Dashboard...</div>;

    // --- Chart Styling Constants ---
    const neonBlue = '#00f2ff';
    const neonPurple = '#bf00ff';
    const neonGreen = '#00ff9d';
    const neonRed = '#ff0055';
    const gridColor = '#1f2937'; // gray-800

    const commonOptions = {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'bottom',
                labels: {
                    color: '#9ca3af', // gray-400
                    usePointStyle: true,
                    padding: 20,
                    font: { family: 'ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace' }
                }
            },
            title: { display: false }
        },
        scales: {
            x: {
                grid: { color: gridColor },
                ticks: { color: '#6b7280' } // gray-500
            },
            y: {
                grid: { color: gridColor },
                ticks: { color: '#6b7280' }
            }
        }
    };

    // 1. Trend Chart (Line)
    const trendData = {
        labels: data.trend.map(d => d.date),
        datasets: [
            {
                label: 'Total Risk Score',
                data: data.trend.map(d => d.score),
                borderColor: neonRed,
                backgroundColor: (context) => {
                    const ctx = context.chart.ctx;
                    const gradient = ctx.createLinearGradient(0, 0, 0, 300);
                    gradient.addColorStop(0, 'rgba(255, 0, 85, 0.5)');
                    gradient.addColorStop(1, 'rgba(255, 0, 85, 0.0)');
                    return gradient;
                },
                tension: 0.4,
                fill: true,
                pointBackgroundColor: '#000',
                pointBorderColor: neonRed,
                pointHoverBackgroundColor: neonRed,
                pointHoverBorderColor: '#fff',
            },
        ],
    };

    // 2. Severity Chart (Doughnut)
    const severityData = {
        labels: ['Critical', 'High', 'Medium', 'Low'],
        datasets: [
            {
                data: [12, 19, 3, 5],
                backgroundColor: [neonRed, '#f97316', '#eab308', neonGreen], // Red, Orange, Yellow, Green
                borderWidth: 0,
                hoverOffset: 10,
            },
        ],
    };

    // 3. Top Risky Assets (Bar)
    const assetRiskData = {
        labels: ['DB Server', 'Web Server', 'Workstation 1', 'Router'],
        datasets: [
            {
                label: 'Risk Score',
                data: [85, 65, 45, 20],
                backgroundColor: neonBlue,
                borderRadius: 4,
            },
        ],
    };

    // 4. Risk by Category (Radar)
    const radarData = {
        labels: ['Network', 'System', 'Web', 'Data', 'Auth'],
        datasets: [
            {
                label: 'Current Exposure',
                data: [65, 59, 90, 81, 56],
                fill: true,
                backgroundColor: 'rgba(191, 0, 255, 0.2)', // Purple transparent
                borderColor: neonPurple,
                pointBackgroundColor: neonPurple,
                pointBorderColor: '#fff',
            },
        ],
    };

    const radarOptions = {
        ...commonOptions,
        scales: {
            r: {
                grid: { color: gridColor },
                angleLines: { color: gridColor },
                pointLabels: { color: '#9ca3af' },
                ticks: { display: false }
            }
        }
    };

    // 5. Compliance Status (Doughnut)
    const complianceData = {
        labels: ['Compliant', 'Non-Compliant'],
        datasets: [
            {
                data: [data.compliance_percentage, 100 - data.compliance_percentage],
                backgroundColor: [neonGreen, '#374151'], // Green vs Dark Gray
                borderWidth: 0,
                cutout: '75%',
            },
        ],
    };

                            <div className="h-4 w-px bg-gray-700"></div>
                            <span className={`text-xs font-mono ${threats[0].type === 'CRITICAL' ? 'text-[#ff0055] animate-pulse font-bold' : threats[0].type === 'WARNING' ? 'text-[#ffcc00]' : 'text-[#00f2ff]'}`}>
                                [{threats[0].time}] {threats[0].type}: {threats[0].message}
                            </span>
                        </div >

    <div className="px-4 py-1.5 rounded-full bg-green-900/10 border border-green-500/20 text-green-400 text-xs font-mono animate-pulse shadow-[0_0_15px_rgba(0,255,157,0.1)] flex items-center gap-2">
        <span className="w-2 h-2 rounded-full bg-green-500"></span> SYSTEM ONLINE
    </div>
                    </div >
                </header >

    {/* KPI Strip */ }
    < div className = "grid grid-cols-4 gap-6" >
        {/* Total Risk */ }
        < div className = "bg-gray-900/30 border border-gray-800 rounded-xl p-4 backdrop-blur-sm flex items-center justify-between hover:border-gray-700 transition-colors group" >
                        <div>
                            <p className="text-gray-500 text-[10px] uppercase tracking-widest font-bold group-hover:text-gray-400 transition-colors">Total Risk</p>
                            <p className={`text-3xl font-bold font-mono mt-1 ${data?.total_risk_score > 1000 ? 'text-[#ff0055] drop-shadow-[0_0_8px_rgba(255,0,85,0.5)]' : 'text-[#00ff9d] drop-shadow-[0_0_8px_rgba(0,255,157,0.5)]'}`}>
                                {data?.total_risk_score.toFixed(0) || 0}
                            </p>
                        </div>
                        <div className="h-10 w-10 rounded-full border border-gray-800 bg-black/50 flex items-center justify-center group-hover:border-gray-600 transition-colors">
                            <span className="text-xs text-gray-500">â–¼</span>
                        </div>
                    </div >

    {/* Active Threats */ }
    < div className = "bg-gray-900/30 border border-gray-800 rounded-xl p-4 backdrop-blur-sm flex items-center justify-between hover:border-gray-700 transition-colors" >
                        <div>
                            <p className="text-gray-500 text-[10px] uppercase tracking-widest font-bold">Active Threats</p>
                            <p className="text-3xl font-bold font-mono mt-1 text-[#ffcc00] drop-shadow-[0_0_8px_rgba(255,204,0,0.3)]">3</p>
                        </div>
                        <div className="h-2 w-2 rounded-full bg-[#ffcc00] shadow-[0_0_10px_#ffcc00] animate-ping"></div>
                    </div >

    {/* Compliance */ }
    < div className = "bg-gray-900/30 border border-gray-800 rounded-xl p-4 backdrop-blur-sm flex items-center justify-between hover:border-gray-700 transition-colors" >
                        <div>
                            <p className="text-gray-500 text-[10px] uppercase tracking-widest font-bold">Compliance</p>
                            <p className="text-3xl font-bold font-mono mt-1 text-white">
                                {data?.compliance_percentage.toFixed(0) || 100}%
                            </p>
                        </div>
                        <div className="h-10 w-10">
                            <Doughnut data={complianceData} options={{ plugins: { legend: { display: false }, tooltip: { enabled: false } }, cutout: '75%' }} />
                        </div>
                    </div >

    {/* External Exposure */ }
    < div className = "bg-gray-900/30 border-l-2 border-l-[#f97316] border-y border-r border-gray-800 rounded-xl p-4 backdrop-blur-sm hover:bg-gray-900/50 transition-colors" >
                        <div className="flex justify-between items-start">
                            <p className="text-gray-500 text-[10px] uppercase tracking-widest font-bold">External Exposure</p>
                            <span className="text-[10px] text-[#f97316] bg-[#f97316]/10 px-1.5 py-0.5 rounded border border-[#f97316]/20">SHODAN</span>
                        </div>
                        <div className="flex items-baseline gap-3 mt-2">
                            <p className="text-xl font-bold font-mono text-white tracking-tight">
                                {externalRisk?.exposed ? 'DETECTED' : 'SECURE'}
                            </p>
                            <span className={`text-xs font-mono border-b ${externalRisk?.exposed ? 'text-[#ff0055] border-[#ff0055]' : 'text-[#00ff9d] border-[#00ff9d]'}`}>
                                {externalRisk ? `${externalRisk.ports?.length || 0} Ports Open` : 'Checking...'}
                            </span>
                        </div>
                    </div >
                </div >
            </div >

    {/* TIER 2: INVESTIGATION LAYER (Middle 55%) */ }
    < div className = "flex-1 min-h-0 mb-6 relative bg-gray-900/20 border border-gray-800 rounded-2xl overflow-hidden shadow-2xl" >
        {/* Force Graph Container - needs to fill height */ }
        < div className = "h-full w-full" >
            <NetworkTopology />
                </div >
            </div >

    {/* TIER 3: EVIDENCE & ACTION LAYER (Bottom 30%) */ }
    < div className = "flex-none h-[30%] grid grid-cols-3 gap-6 min-h-0" >

        {/* Action Panel (Scanner) */ }
        < div className = "col-span-1 bg-gray-900/30 border border-gray-800 rounded-xl p-5 flex flex-col backdrop-blur-sm" >
                    <h4 className="text-gray-400 text-xs font-bold uppercase tracking-widest mb-4 flex items-center gap-2">
                        <span className="w-1.5 h-1.5 bg-[#00f2ff] rounded-full"></span>
                        Command & Control
                    </h4>

                    <div className="space-y-4 flex-1 overflow-y-auto pr-2 custom-scrollbar">
                        <div>
                            <label className="text-[10px] text-gray-500 uppercase tracking-wider font-bold block mb-2">Target IP / Range</label>
                            <div className="flex gap-3">
                                <input
                                    type="text"
                                    value={scanTarget}
                                    onChange={(e) => setScanTarget(e.target.value)}
                                    className="flex-1 bg-black/40 border border-gray-700 rounded-lg px-4 py-2 text-sm text-[#00f2ff] font-mono focus:border-[#00f2ff] focus:ring-1 focus:ring-[#00f2ff] outline-none transition-all placeholder-gray-700"
                                    placeholder="192.168.1.0/24"
                                />
                                <button
                                    onClick={handleScan}
                                    disabled={scanning}
                                    className={`px-6 py-2 rounded-lg font-bold text-xs uppercase tracking-wider transition-all duration-300 shadow-lg ${scanning
                                        ? 'bg-gray-800 text-gray-500 cursor-not-allowed border border-gray-700'
                                        : 'bg-[#00f2ff]/10 text-[#00f2ff] border border-[#00f2ff]/50 hover:bg-[#00f2ff] hover:text-black hover:shadow-[0_0_20px_rgba(0,242,255,0.4)]'
                                        }`}
                                >
                                    {scanning ? 'Scanning...' : 'Scan'}
                                </button>
                            </div>
                        </div>

                        <div className="grid grid-cols-2 gap-3 pt-2">
                            <button className="py-3 border border-gray-700 rounded-lg hover:border-[#ff0055] hover:text-[#ff0055] hover:bg-[#ff0055]/5 text-gray-500 text-xs font-bold uppercase tracking-wider transition-all duration-300">
                                Stop All
                            </button>
                            <button className="py-3 border border-gray-700 rounded-lg hover:border-[#00ff9d] hover:text-[#00ff9d] hover:bg-[#00ff9d]/5 text-gray-500 text-xs font-bold uppercase tracking-wider transition-all duration-300">
                                Generate Report
                            </button>
                        </div>
                    </div>
                </div >

    {/* Metrics Tabs (Charts) */ }
    < div className = "col-span-2 bg-gray-900/30 border border-gray-800 rounded-xl p-5 flex flex-col backdrop-blur-sm" >
                    <div className="flex gap-6 border-b border-gray-800/50 pb-2 mb-4">
                        <button className="text-xs font-bold text-[#00f2ff] border-b-2 border-[#00f2ff] pb-2 -mb-2.5 tracking-wider">RISK TREND</button>
                        <button className="text-xs font-bold text-gray-500 hover:text-gray-300 pb-2 tracking-wider transition-colors">VULNERABILITIES</button>
                        <button className="text-xs font-bold text-gray-500 hover:text-gray-300 pb-2 tracking-wider transition-colors">ASSETS</button>
                    </div>
                    <div className="flex-1 min-h-0 relative">
                        <Line data={trendData} options={{ ...commonOptions, maintainAspectRatio: false }} />
                    </div>
                </div >

            </div >
        </div >
    );
};

export default Dashboard;
