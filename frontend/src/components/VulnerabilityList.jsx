import React, { useEffect, useState } from 'react';
import axios from 'axios';
import { useAuth } from '../context/AuthContext';

const VulnerabilityList = ({ onUpdate }) => {
    const { token } = useAuth();
    const [risks, setRisks] = useState([]);

    useEffect(() => {
        fetchRisks();
    }, []);

    const fetchRisks = async () => {
        try {
            const response = await axios.get('http://localhost:5000/api/risks', {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            setRisks(response.data);
        } catch (error) {
            console.error("Error fetching risks", error);
        }
    };

    const handleStatusChange = async (id, newStatus) => {
        try {
            await axios.patch(`http://localhost:5000/api/risks/${id}`, { status: newStatus }, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            fetchRisks();
            if (onUpdate) onUpdate();
        } catch (error) {
            console.error("Error updating status", error);
        }
    };

    const handleRemediate = async (risk) => {
        try {
            alert(`Initiating automated remediation for ${risk.cve}...`);
            await axios.post('http://localhost:5000/api/remediate', {
                asset_id: 1, // Mock asset ID
                risk_id: risk.id,
                action: 'patch'
            }, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            alert('Remediation successful! Risk closed.');
            fetchRisks();
            if (onUpdate) onUpdate();
        } catch (error) {
            console.error("Remediation failed", error);
            alert("Remediation failed.");
        }
    };

    return (
        <div style={{ overflowX: 'auto' }}>
            <table>
                <thead>
                    <tr>
                        <th>Asset</th>
                        <th>Vulnerability</th>
                        <th>Severity</th>
                        <th>Custom Score</th>
                        <th>Recommendation</th>
                        <th>Status</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    {risks.map(risk => (
                        <tr key={risk.id}>
                            <td>{risk.asset}</td>
                            <td>
                                <strong>{risk.cve}</strong><br />
                                <small>{risk.description}</small>
                            </td>
                            <td>{risk.base_score}</td>
                            <td>{risk.custom_score.toFixed(1)}</td>
                            <td>{risk.remediation}</td>
                            <td>
                                <select
                                    value={risk.status}
                                    onChange={(e) => handleStatusChange(risk.id, e.target.value)}
                                    className={`status-badge status-${risk.status}`}
                                >
                                    <option value="New">New</option>
                                    <option value="In Progress">In Progress</option>
                                    <option value="Closed">Closed</option>
                                </select>
                            </td>
                            <td>
                                {risk.status !== 'Closed' && (
                                    <button
                                        onClick={() => handleRemediate(risk)}
                                        style={{
                                            backgroundColor: '#e74c3c',
                                            color: 'white',
                                            border: 'none',
                                            borderRadius: '4px',
                                            fontSize: '0.8em',
                                            padding: '5px 10px',
                                            cursor: 'pointer'
                                        }}
                                    >
                                        ðŸ”§ Fix It
                                    </button>
                                )}
                            </td>
                        </tr>
                    ))}
                </tbody>
            </table>
        </div>
    );
};

export default VulnerabilityList;
