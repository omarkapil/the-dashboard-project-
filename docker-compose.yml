services:
  backend:
    build: ./backend
    container_name: sme_dashboard_backend
    ports:
      - "8000:8000"
    volumes:
      - ./backend:/app
      # - gvm_socket:/run/gvmd
    environment:
      - DATABASE_URL=postgresql://user:password@db:5432/sme_cyber_db
      - REDIS_URL=redis://redis:6379/0
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - OPENVAS_HOST=openvas
      - OPENVAS_PORT=9390
      - OPENVAS_CONNECTION_TYPE=tls # immauss/openvas uses TLS on 9390
      # - OPENVAS_SOCKET=/run/gvmd/gvmd.sock
      - ELASTICSEARCH_URL=http://elasticsearch:9200
      - WAZUH_API_URL=https://wazuh:55000
      - WAZUH_API_USER=wazuh
      - WAZUH_API_PASSWORD=wazuh
      - N8N_WEBHOOK_URL=http://n8n:5678/webhook/
    networks:
      - default
      - lab_network
    depends_on:
      - db
      - redis

  frontend:
    build: ./frontend
    container_name: sme_dashboard_frontend
    ports:
      - "5173:80"
    volumes:
      - ./frontend:/app
      - /app/node_modules
    environment:
      - VITE_API_URL=http://localhost:8000
    depends_on:
      - backend

  db:
    image: postgres:15-alpine
    container_name: sme_dashboard_db
    environment:
      - POSTGRES_USER=user
      - POSTGRES_PASSWORD=password
      - POSTGRES_DB=sme_cyber_db
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data

  redis:
    image: redis:7-alpine
    container_name: sme_dashboard_redis
    ports:
      - "6379:6379"

  celery_worker:
    build: ./backend
    container_name: sme_dashboard_celery
    command: celery -A app.core.celery_app worker --loglevel=info
    environment:
      - DATABASE_URL=postgresql://user:password@db:5432/sme_cyber_db
      - REDIS_URL=redis://redis:6379/0
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - ELASTICSEARCH_URL=http://elasticsearch:9200
      - WAZUH_API_URL=https://wazuh:55000
      - WAZUH_API_USER=wazuh
      - WAZUH_API_PASSWORD=wazuh
      - N8N_WEBHOOK_URL=http://n8n:5678/webhook/
    networks:
      - default
      - lab_network
    depends_on:
      - backend
      - redis

  celery_beat:
    build: ./backend
    container_name: sme_dashboard_beat
    command: celery -A app.core.celery_app beat --loglevel=info
    environment:
      - DATABASE_URL=postgresql://user:password@db:5432/sme_cyber_db
      - REDIS_URL=redis://redis:6379/0
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - ELASTICSEARCH_URL=http://elasticsearch:9200
      - WAZUH_API_URL=https://wazuh:55000
      - WAZUH_API_USER=wazuh
      - WAZUH_API_PASSWORD=wazuh
      - N8N_WEBHOOK_URL=http://n8n:5678/webhook/
    depends_on:
      - backend
      - redis

  openvas:
    image: immauss/openvas
    container_name: sme_dashboard_openvas
    restart: unless-stopped
    environment:
      - PUBLIC_HOSTNAME=127.0.0.1
      - SKIPGSAD=true
    ports:
      - "9392:9392" # Web UI
      - "9390:9390" # GMP
    volumes:
      - gvm_data:/var/lib/openvas
    entrypoint: [ "/bin/sh", "-c", "rm -f /var/lib/openvas/feed-update.lock && find /var/lib -name postmaster.pid -delete && /scripts/start.sh" ]
    networks:
      - default
      - lab_network

  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.11.1
    container_name: sme_dashboard_elastic
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=false
      - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
    ports:
      - "9200:9200"
    volumes:
      - elastic_data:/usr/share/elasticsearch/data
    networks:
      - default
      - lab_network

  kibana:
    image: docker.elastic.co/kibana/kibana:8.11.1
    container_name: sme_dashboard_kibana
    environment:
      - ELASTICSEARCH_HOSTS=http://elasticsearch:9200
    ports:
      - "5601:5601"
    depends_on:
      - elasticsearch
    networks:
      - default
      - lab_network

  wazuh:
    image: wazuh/wazuh-manager:4.7.2
    container_name: sme_dashboard_wazuh
    ports:
      - "1514:1514"
      - "1515:1515"
      - "55000:55000"
    environment:
      - WAZUH_API_START="true"
    networks:
      - default
      - lab_network

  n8n:
    image: n8nio/n8n:latest
    container_name: sme_dashboard_n8n
    ports:
      - "5678:5678"
    environment:
      - N8N_HOST=0.0.0.0
      - N8N_PORT=5678
      - N8N_PROTOCOL=http
      - NODE_ENV=production
      - WEBHOOK_URL=http://localhost:5678/
      - GENERIC_TIMEZONE=UTC
    volumes:
      - n8n_data:/home/node/.n8n
    networks:
      - default
      - lab_network

networks:
  default:
  lab_network:
    external: true
    name: the-dashboard-project-_lab_network

volumes:
  postgres_data:
  gvm_data:
  elastic_data:
  n8n_data:


